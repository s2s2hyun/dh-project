---
title: 'Nextjs14 + React-query '
description: 'Nextjs14 + React-query app router ì ìš©'
image: '../../public/blogs/logo/react-query-logo.png'
publishedAt: '2024-01-17'
updatedAt: '2024-01-17'
author: 'DH'
isPublished: true
tags:
  - Next.JS
---

NextJs ì™€ React-queryë¥¼ ê°™ì´ ì‚¬ìš©í•œë‹¤ë©´ ì–´ë–¨ê¹Œ?

- React-queryëŠ” NextJs ì—ì„œ pre-fetchingì´ ê°€ëŠ¥í•˜ë‹¤. ì´ë¡œ ì¸í•´ ì„±ëŠ¥ í–¥ìƒì— ë„ì›€ì„ ì¤€ë‹¤.
  ğŸ“Œ pre-fetching ì´ë€? í˜ì´ì§€ê°€ ë Œë”ë§ ë˜ê¸° ì „ì— ë¯¸ë¦¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ë§í•œë‹¤.(ë°ì´í„° ìºì‹± ì‘ì—…ë„ pre-fetchingì— í¬í•¨ëœë‹¤.)

- ë°ì´í„° ìš”ì²­ ì½”ë“œë¥¼ ì‰½ê²Œ ê´€ë¦¬ê°€ ê°€ëŠ¥í•˜ë‹¤.

- ë™ì  ë°ì´í„° ê´€ë¦¬í•˜ëŠ” ë¹„ë™ê¸° ë¡œì§ì„ ì‰½ê²Œ ë‹¤ë£° ìˆ˜ ìˆë‹¤.

## 1. ì„¤ì¹˜

[react-query tanstack Link](https://tanstack.com/query/v4/docs/react/installation)

```
# npm
npm i @tanstack/react-query
# pnpm
pnpm add @tanstack/react-query
# yarn
yarn add @tanstack/react-query
```

## 2 Next.Js ì— ì ìš©

Next.js 13.4 ë²„ì „ ì´ìƒì€ App Router í”„ë¡œì íŠ¸ë¡œ ë§Œë“¤ìˆ˜ìˆìœ¼ë¯€ë¡œ, ì´ë²ˆ ì„¤ëª…ì€ App Router ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.
ì—¬ëŸ¬ ë°©ë²•ì´ ìˆëŠ”ë°, ì €ëŠ” Provider ë¥¼ ë§Œë“¤ì–´ ê±°ê¸°ì— client ë° ì¿¼ë¦¬ ìƒì„± í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ Layoutì— ì ìš©í•˜ëŠ” ë°©ë²•ì„ ê³µìœ í•˜ê² ìŠµë‹ˆë‹¤.

### 2.1 ReactQueryProvider ë§Œë“¤ê¸°

```
"use client";

import { QueryClientProvider, QueryClient } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { useState } from "react";

export default function ReactQueryProviders({
  children,
}: React.PropsWithChildren) {
  const [client] = useState(
    new QueryClient({
      defaultOptions: {
        queries: {
          refetchOnWindowFocus: false, // ìœˆë„ìš°ê°€ ë‹¤ì‹œ í¬ì»¤ìŠ¤ë˜ì—ˆì„ë•Œ ë°ì´í„°ë¥¼ refetch
          refetchOnMount: false, // ë°ì´í„°ê°€ stale ìƒíƒœì´ë©´ ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë  ë•Œ refetch
          retry: 1, // API ìš”ì²­ ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ í•˜ëŠ” ì˜µì…˜ (ì„¤ì •ê°’ ë§Œí¼ ì¬ì‹œë„)
        },
      },
    })
  );

  return (
    <QueryClientProvider client={client}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}

```

1. 'use client' ë¥¼ ì¶”ê°€.
   Next.Js App router ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì„œë²„ ì»´í¬ë„ŒíŠ¸ì§€ë§Œ, ë¦¬ì•¡íŠ¸ì¿¼ë¦¬ëŠ” QueryClientProvider ë¥¼ ë¹„ë¡¯í•´ ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

2. useStateë¡œ new QueryClient ìƒì„±
   ì°¸ì¡° ë™ì¼ì„±ì„ ìœ ì§€í•˜ê³  Reactì—ì„œ ì˜ˆìƒëŒ€ë¡œ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ë° ë„ì›€ë¼ useStateë¡œ ìƒì„±. ìì„¸í•œ ì„¤ëª…ì€ ì•„ë˜ ì¶”ê°€ì ìœ¼ë¡œ í•˜ê² ìŠµë‹ˆë‹¤.

3. defaultOptions ì„¤ì •
   ì„œë²„ ë¹„ìš©ì„ ì¤„ì´ê¸° ìœ„í•´ refetch ì„¤ì •ì„ false ë¡œ ë‘ì—ˆìŠµë‹ˆë‹¤.

4. ë§Œë“  queryClientë¥¼ QueryClientProvider ì»´í¬ë„ŒíŠ¸ì˜ clientì— ë„£ì–´ì¤Œ

5. QueryClientProviderë¡œ ë˜í•‘ì„ í•˜ë©´ ëª¨ë“  í•˜ìœ„ êµ¬ì„± ìš”ì†Œê°€ React Query í™˜ê²½ì— ì•¡ì„¸ìŠ¤ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. êµ¬ì„± ìš”ì†Œ ê³„ì¸µ êµ¬ì¡°ë¥¼ í†µí•´ propsë¥¼ ê¹Šì´ ì „ë‹¬í•  í•„ìš” ì—†ì´ ë‹¤ì–‘í•œ êµ¬ì„± ìš”ì†Œ ê°„ì— ì „ì—­ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

6. ReactQueryDevtoolsì€ ì„ íƒì´ë©°, react-query ê°œë°œ ë„êµ¬ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

> ì¶”ê°€ : queryClient ì„¤ì •ì— useStateë¥¼ í™œìš©í–ˆì„ê¹Œ?

useStateë¥¼ í™œìš©í•˜ëŠ” ê²ƒì€ React Queryì˜ QueryClientProvider ì„¤ì •ì—ì„œ íŠ¹ë³„í•œ ê²½ìš°ì˜ ì„ íƒì´ë¼ í•  ìˆ˜ ìˆë‹¤. useStateë¥¼ ì ìš©í•˜ë©´ ì°¸ì¡° ë™ì¼ì„±ì„ ìœ ì§€í•˜ë©°, ë˜í•œ React Queryì™€ Reactê°€ ì˜ˆìƒí•˜ëŠ” ìƒíƒœ ê´€ë¦¬ë¥¼ ì¡°ì ˆí•˜ê³ , ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ê³¼ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ì¡°ì ˆí•˜ê¸° ìœ„í•¨ì´ë‹¤.
ì´ì— ëŒ€í•œ ëª‡ ê°€ì§€ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. ì´ˆê¸° ë Œë”ë§ ì¤‘ ì„¤ì •: React QueryëŠ” ì´ˆê¸° ë Œë”ë§ ë™ì•ˆì— QueryClientë¥¼ ì„¤ì •í•˜ê³  ì‚¬ìš©í•˜ê¸° ìœ„í•œ ìƒíƒœë¥¼ í•„ìš”ë¡œ í•œë‹¤.
   ì´ˆê¸° ë Œë”ë§ ë™ì•ˆì—ë§Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ë¥¼ ì œê³µí•˜ë©´ Lazy ì´ˆê¸° ìƒíƒœ(Lazy inital state)ë¥¼
   í™œìš©í•´ ì´ˆê¸° ë Œë”ë§ ë™ì•ˆì—ë§Œ QueryClientë¥¼ ìƒì„±í•˜ê³ , ì´í›„ì—ëŠ” ì°¸ì¡° ë™ì¼ì„±ì„ ìœ ì§€í•œë‹¤.
   ì´ê²ƒì€ ì´ˆê¸° ì„¤ì •ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜ë‹¤.
2. ë™ì  ì„¤ì • ê´€ë¦¬: QueryClientProviderì˜ ì„¤ì •ì„ ë™ì ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•  ë•Œ, useState ë¥¼ í™œìš©í•´ QueryClientë¥¼ ìƒíƒœë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ìœ ìš©í•˜ë‹¤. ë™ì ìœ¼ë¡œ ì„¤ì •ì„ ë³€ê²½í•˜ë ¤ë©´ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ê·¸ ë³€ê²½ì„ QueryClientProvider ì— ì ìš©í•˜ë©´ ëœë‹¤.

3. ìµœì í™” : React QueryëŠ” ë Œë”ë§ ì„±ëŠ¥ê³¼ ë°ì´í„° ìºì‹±ì— ëŒ€í•œ ë‹¤ì–‘í•œ ìµœì í™”ë¥¼ ì œê³µí•˜ë¯€ë¡œ, ì´ëŸ¬í•œ ìµœì í™”ë¥¼ í™œìš©í•´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

## 3. ë£¨íŠ¸ ë ˆì´ì•„ì›ƒì— ì ìš©í•˜ê¸°

Next.Js App RouterëŠ” ë¼ìš°íŒ…ì— ì˜í–¥ì„ ì£¼ëŠ” íŒŒì¼ ë° í´ë”ê°€ ìˆëŠ”ë°, ê·¸ ì¤‘ í•˜ë‚˜ê°€ layout.tsx ì´ë‹¤.
ê°„ë‹¨í•˜ê²Œ ì–˜ê¸°í•´ì„œ layout.tsxëŠ” ë„ë©”ì¸ ì£¼ì†Œì— ì˜í–¥ì„ ì£¼ëŠ” page.tsx íŒŒì¼ ë° ê·¸ í•˜ìœ„ ë””ë ‰í† ë¦¬ íŒŒì¼ë“¤ì—ê²Œ UI ë° ì„¤ì •ì„ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” íŒŒì¼ì´ë‹¤.
ì´ì „ Next.js Page Router êµ¬ì¡°ì—ì„œ \_app.tsx ì™€ ë¹„ìŠ·í•œ ê¸°ëŠ¥ì„ ê°€ì§„ íŒŒì¼ì´ë‹¤.

<Image
  src="/blogs/nextjs-reactquery/nextjs-approuter.png"
  width="1000"
  height="600"
  alt="Image"
  sizes="100vw"
/>

```
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import ReactQueryProviders from "@/utils/react-query-provider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <ReactQueryProviders>{children}</ReactQueryProviders>
      </body>
    </html>
  );
}

```

êµ¬í˜„ ì™„ë£Œì…ë‹ˆë‹¤.

## 4. React ì•±ì—ì„œ React-Queryë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° í‘œì‹œ

ì €ëŠ” Rest Api ë¥¼ Korean json ì œê³µëœ api ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.

[Korean json Link](https://koreanjson.com/)

```
"use client";

import React from "react";
import styles from "./page.module.css";
import { useQuery } from "@tanstack/react-query";

interface jsonDataProps {
  id: number;
  title: string;
  createdAt: string;
}

async function fetchData() {
  const response = await fetch("https://koreanjson.com/posts");
  if (!response.ok) {
    throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì•ˆì˜¤ê³  ìˆìŠµë‹ˆë‹¤.");
  }
  console.log(response, "response");
  return response.json();
}

function DataComponent() {
  const { data, isLoading, error } = useQuery({
    queryKey: ["data"],
    queryFn: fetchData,
  });

  if (isLoading) return <div>ë¡œë”©ì¤‘...</div>;
  if (error) return <div>ì˜¤ë¥˜ë°œìƒ: {error.message}</div>;

  return (
    <div>
      {data.map((item: jsonDataProps) => {
        return (
          <div key={item.id}>
            <div>{item.id}</div>
            <div>{item.title}</div>
            <div>{item.createdAt}</div>
          </div>
        );
      })}
    </div>
  );
}

export default function Home() {
  return (
    <main className={styles.main}>
      <div>
        <h4>Hello React-query</h4>
        <DataComponent />
      </div>
    </main>
  );
}

```

### 4.1 ì„¤ëª…

1. fetchData í•¨ìˆ˜ëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ë§í–ˆë“¯ koreanjson URL ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

2. DataComponent í•¨ìˆ˜ ì»´í¬ë„ŒíŠ¸ëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œí•˜ëŠ” ë¶€ë¶„ì´ë©°, useQuery í›…ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³ , ë°ì´í„°ì˜ ë¡œë”© ìƒíƒœ ë° ì˜¤ë¥˜ ìƒíƒœë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
   useQueryë¥¼ queryKeyì™€ queryFn ì†ì„±ì„ í¬í•¨í•œ ê°ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. <br /> ì´ë¥¼ í†µí•´ query í‚¤ë¥¼ ["data"]ë¡œ ì§€ì •í•˜ê³  query í•¨ìˆ˜ë¥¼ fetchDataë¡œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   ê°€ì§€ê³ ì˜¨ ë°ì´í„°ë¥¼ map í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ë°ì´í„° í•­ëª©ì„ ìˆœíšŒí•˜ê³ , ê°
   í•­ëª©ì˜ id,title,createdAtë¥¼ í‘œê¸°í–ˆìŠµë‹ˆë‹¤.

> [tankstack query Link](https://tanstack.com/query/latest/docs/react/guides/queries) ê³µì‹ DOCS ì…ë‹ˆë‹¤. ì•„ë¬´ë˜ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš© í•˜ë‹¤ë³´ë‹ˆ, ë²„ì „ì— ë”°ë¥¸ ì‚¬ìš©ë°©ë²•ì´ ê°ê° ë‹¤ë¦…ë‹ˆë‹¤.<br />
> ì €ëŠ” ì „ì— ì‚¬ìš©ì‹œ v3 ë²„ì „ì„ ì‚¬ìš©í–ˆì—ˆëŠ”ë°, ì´ë²ˆì— ì‚¬ìš©í•œ ë²„ì „ì€ v5 ìµœì‹ ë²„ì „ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

## 5. ë§ˆë¬´ë¦¬

ì´ì „ì—ë„ ì‚¬ìš©ì„ í•´ë´¤ì§€ë§Œ React-QueryëŠ” React ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°, ìºì‹± ë° ìƒíƒœ ê´€ë¦¬ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ê°•ë ¥í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.<br /> ë¹„ë™ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì²˜ë¦¬, ì˜¤ë¥˜ ì²˜ë¦¬, í˜ì´ì§€ë„¤ì´ì…˜, ì¸í”¼ë‹ˆí‹°ìŠ¤í¬ë¡¤ ë“± ì‚¬ìš©ìì—ê²Œ ì¢‹ì€ ê¸°ëŠ¥ì„ ì œê³µí•˜ê¸°ì— ë§¤ìš° ì¢‹ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¼ê³  ìƒê°ì´ ë“­ë‹ˆë‹¤.
ì¶”í›„ì— ì¸í”¼ë‹ˆí‹° ìŠ¤í¬ë¡¤ì´ë‚˜ í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ëŠ¥êµ¬í˜„ì„ ì¶”ê°€ì ìœ¼ë¡œ ì‘ì„±ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤. ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.
